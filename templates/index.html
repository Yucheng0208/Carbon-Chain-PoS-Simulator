<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Carbon Chain PoS Simulator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

</head>
<body class="bg-light">

<div class="container my-4">
    <h1 class="text-center mb-4">🌱 Carbon Chain PoS Simulator</h1>

    <div class="card p-4 mb-4">
        <h3>發送碳權交易</h3>
        <form id="transactionForm">
            <div class="row">
                <div class="col-md-4">
                    <label for="sender" class="form-label">送出者</label>
                    <select class="form-select" id="sender" required>
                        {% for name in wallets %}
                        <option value="{{ name }}">{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="receiver" class="form-label">接收者</label>
                    <select class="form-select" id="receiver" required>
                        {% for name in wallets %}
                        <option value="{{ name }}">{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="amount" class="form-label">金額 (碳權數)</label>
                    <input type="number" class="form-control" id="amount" min="1" required>
                </div>
            </div>
            <div class="d-grid mt-3">
                <button type="submit" class="btn btn-success">提交交易</button>
            </div>
        </form>
    </div>

    <div class="card p-4 mb-4">
        <h3>礦工操作</h3>
        <div class="d-grid gap-2">
            <button class="btn btn-primary" onclick="mine()">手動挖礦</button>
            <button class="btn btn-warning" onclick="toggleAutoMine()">切換自動挖礦</button>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-6">
            <div class="card p-3">
                <h4>錢包狀態</h4>
                <ul id="walletsList" class="list-group"></ul>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card p-3">
                <h4>區塊鏈資料</h4>
                <ul id="chainList" class="list-group"></ul>
            </div>
        </div>
    </div>
</div>

<script>
async function refresh() {
    const wallets = await fetch('/api/wallets').then(res => res.json());
    const chain = await fetch('/api/chain').then(res => res.json());

    const walletsList = document.getElementById('walletsList');
    walletsList.innerHTML = '';
    for (const [name, info] of Object.entries(wallets)) {
        walletsList.innerHTML += `<li class="list-group-item">${name} - Balance: ${info.balance}, Stake: ${info.stake}</li>`;
    }

    const chainList = document.getElementById('chainList');
    chainList.innerHTML = '';
    for (const block of chain) {
        chainList.innerHTML += `<li class="list-group-item">#${block.index} by ${block.validator}</li>`;
    }
}

document.getElementById('transactionForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const sender = document.getElementById('sender').value;
    const receiver = document.getElementById('receiver').value;
    const amount = document.getElementById('amount').value;
    await fetch('/api/transaction', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({sender, receiver, amount})
    });
    refresh();
});

async function mine() {
    await fetch('/api/mine', {method: 'POST'});
    refresh();
}

async function toggleAutoMine() {
    await fetch('/api/auto_mine', {method: 'POST'});
}

setInterval(refresh, 5000); // 每5秒刷新
refresh();
</script>

</body>
</html>
